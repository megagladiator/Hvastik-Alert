# Реализация чата в реальном времени

## Обзор

Реализован полнофункциональный чат между пользователями и владельцами питомцев с поддержкой сообщений в реальном времени.

## Архитектура

### База данных

#### Таблица `chats`
```sql
CREATE TABLE chats (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    pet_id UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
    user_id UUID NOT NULL,
    owner_id UUID NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(pet_id, user_id)
);
```

#### Таблица `messages`
```sql
CREATE TABLE messages (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    chat_id UUID NOT NULL,
    sender_id UUID NOT NULL,
    sender_type VARCHAR(20) NOT NULL CHECK (sender_type IN ('user', 'owner')),
    text TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Безопасность

- **Row Level Security (RLS)** включен для обеих таблиц
- Пользователи могут видеть только чаты, в которых участвуют
- Пользователи могут отправлять сообщения только в своих чатах

## Функциональность

### 1. Создание чата
- При первом обращении к питомцу автоматически создается чат
- Один пользователь может иметь только один чат с одним питомцем
- Чат связывает пользователя с владельцем питомца

### 2. Отправка сообщений
- Пользователи могут отправлять текстовые сообщения
- Сообщения сохраняются в базе данных
- Поддержка индикации отправки (спиннер)

### 3. Получение сообщений в реальном времени
- Использование Supabase Realtime для мгновенного получения сообщений
- Автоматическая прокрутка к новым сообщениям
- Отображение времени отправки

### 4. Интерфейс чата

#### Страница чата (`/chat/[id]`)
- Заголовок с информацией о питомце
- Область сообщений с прокруткой
- Поле ввода с кнопкой отправки
- Индикаторы загрузки и ошибок
- Правила безопасности

#### Страница списка чатов (`/chats`)
- Список всех чатов пользователя
- Поиск по питомцам
- Отображение последнего сообщения
- Время создания чата

## Техническая реализация

### Хук `useChat`
```typescript
const { messages, loading, sending, error, sendMessage } = useChat({
  petId: string,
  currentUserId?: string
});
```

**Функции:**
- `getOrCreateChat()` - создание или получение существующего чата
- `loadMessages()` - загрузка истории сообщений
- `subscribeToMessages()` - подписка на новые сообщения
- `sendMessage()` - отправка сообщения

### Supabase Realtime
```typescript
const channel = supabase
  .channel(`chat:${chatId}`)
  .on("postgres_changes", {
    event: "INSERT",
    schema: "public",
    table: "messages",
    filter: `chat_id=eq.${chatId}`,
  }, (payload) => {
    // Обработка нового сообщения
  })
  .subscribe()
```

## Пользовательский опыт

### Для неавторизованных пользователей
- Показ демо-данных
- Предложение войти в систему
- Ссылка на страницу авторизации

### Для авторизованных пользователей
- Полный доступ к чату
- Отправка и получение сообщений
- Просмотр истории сообщений
- Уведомления о новых сообщениях

### Состояния интерфейса
- **Загрузка** - спиннер при инициализации
- **Пустой чат** - приветственное сообщение
- **Отправка** - индикатор отправки сообщения
- **Ошибки** - отображение ошибок с возможностью повтора

## Безопасность

### Авторизация
- Требуется авторизация для отправки сообщений
- Проверка прав доступа к чату
- Защита от несанкционированного доступа

### Валидация
- Проверка длины сообщений
- Санитизация ввода
- Защита от XSS

### Приватность
- Сообщения видны только участникам чата
- Номера телефонов скрыты (как в предыдущем изменении)
- Безопасное хранение данных

## Интеграция с существующей системой

### Связь с питомцами
- Чат привязан к конкретному питомцу
- Автоматическое определение владельца
- Отображение информации о питомце в чате

### Навигация
- Добавлена ссылка "Мои чаты" в главное меню
- Переходы между чатами и списком чатов
- Кнопки "Назад" для удобной навигации

## Дальнейшие улучшения

1. **Уведомления** - push-уведомления о новых сообщениях
2. **Файлы** - отправка изображений и документов
3. **Статус** - индикаторы "онлайн" и "печатает"
4. **Архивирование** - возможность архивировать чаты
5. **Экспорт** - сохранение истории чатов
6. **Модерация** - фильтрация нежелательного контента 

## Обзор

Реализован полнофункциональный чат между пользователями и владельцами питомцев с поддержкой сообщений в реальном времени.

## Архитектура

### База данных

#### Таблица `chats`
```sql
CREATE TABLE chats (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    pet_id UUID NOT NULL REFERENCES pets(id) ON DELETE CASCADE,
    user_id UUID NOT NULL,
    owner_id UUID NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(pet_id, user_id)
);
```

#### Таблица `messages`
```sql
CREATE TABLE messages (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    chat_id UUID NOT NULL,
    sender_id UUID NOT NULL,
    sender_type VARCHAR(20) NOT NULL CHECK (sender_type IN ('user', 'owner')),
    text TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Безопасность

- **Row Level Security (RLS)** включен для обеих таблиц
- Пользователи могут видеть только чаты, в которых участвуют
- Пользователи могут отправлять сообщения только в своих чатах

## Функциональность

### 1. Создание чата
- При первом обращении к питомцу автоматически создается чат
- Один пользователь может иметь только один чат с одним питомцем
- Чат связывает пользователя с владельцем питомца

### 2. Отправка сообщений
- Пользователи могут отправлять текстовые сообщения
- Сообщения сохраняются в базе данных
- Поддержка индикации отправки (спиннер)

### 3. Получение сообщений в реальном времени
- Использование Supabase Realtime для мгновенного получения сообщений
- Автоматическая прокрутка к новым сообщениям
- Отображение времени отправки

### 4. Интерфейс чата

#### Страница чата (`/chat/[id]`)
- Заголовок с информацией о питомце
- Область сообщений с прокруткой
- Поле ввода с кнопкой отправки
- Индикаторы загрузки и ошибок
- Правила безопасности

#### Страница списка чатов (`/chats`)
- Список всех чатов пользователя
- Поиск по питомцам
- Отображение последнего сообщения
- Время создания чата

## Техническая реализация

### Хук `useChat`
```typescript
const { messages, loading, sending, error, sendMessage } = useChat({
  petId: string,
  currentUserId?: string
});
```

**Функции:**
- `getOrCreateChat()` - создание или получение существующего чата
- `loadMessages()` - загрузка истории сообщений
- `subscribeToMessages()` - подписка на новые сообщения
- `sendMessage()` - отправка сообщения

### Supabase Realtime
```typescript
const channel = supabase
  .channel(`chat:${chatId}`)
  .on("postgres_changes", {
    event: "INSERT",
    schema: "public",
    table: "messages",
    filter: `chat_id=eq.${chatId}`,
  }, (payload) => {
    // Обработка нового сообщения
  })
  .subscribe()
```

## Пользовательский опыт

### Для неавторизованных пользователей
- Показ демо-данных
- Предложение войти в систему
- Ссылка на страницу авторизации

### Для авторизованных пользователей
- Полный доступ к чату
- Отправка и получение сообщений
- Просмотр истории сообщений
- Уведомления о новых сообщениях

### Состояния интерфейса
- **Загрузка** - спиннер при инициализации
- **Пустой чат** - приветственное сообщение
- **Отправка** - индикатор отправки сообщения
- **Ошибки** - отображение ошибок с возможностью повтора

## Безопасность

### Авторизация
- Требуется авторизация для отправки сообщений
- Проверка прав доступа к чату
- Защита от несанкционированного доступа

### Валидация
- Проверка длины сообщений
- Санитизация ввода
- Защита от XSS

### Приватность
- Сообщения видны только участникам чата
- Номера телефонов скрыты (как в предыдущем изменении)
- Безопасное хранение данных

## Интеграция с существующей системой

### Связь с питомцами
- Чат привязан к конкретному питомцу
- Автоматическое определение владельца
- Отображение информации о питомце в чате

### Навигация
- Добавлена ссылка "Мои чаты" в главное меню
- Переходы между чатами и списком чатов
- Кнопки "Назад" для удобной навигации

## Дальнейшие улучшения

1. **Уведомления** - push-уведомления о новых сообщениях
2. **Файлы** - отправка изображений и документов
3. **Статус** - индикаторы "онлайн" и "печатает"
4. **Архивирование** - возможность архивировать чаты
5. **Экспорт** - сохранение истории чатов
6. **Модерация** - фильтрация нежелательного контента 
 