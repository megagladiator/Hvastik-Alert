(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[505],{3910:function(e,s,a){Promise.resolve().then(a.bind(a,1640))},1640:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return f}});var t=a(7437),r=a(2265),l=a(2869),i=a(6070),n=a(5974),c=a(5186),d=a(2660),o=a(5805),x=a(3247),m=a(9076),h=a(2718),u=a(9334),j=a(8930),v=a(7648),g=a(2141);function f(){let[e,s]=(0,r.useState)([]),[a,f]=(0,r.useState)(!0),[p,N]=(0,r.useState)(""),[y,b]=(0,r.useState)("all"),[w,k]=(0,r.useState)(null);(0,r.useEffect)(()=>{(async()=>{if(!g.O)return;let{data:{user:e}}=await g.O.auth.getUser();if(k(e),!e||"agentgl007@gmail.com"!==e.email){f(!1);return}await C()})()},[]);let C=async()=>{try{let e=await fetch("/api/admin/chats");if(e.ok){let{data:a}=await e.json();console.log("Загружены все чаты:",a),s(a||[])}else{let a=await e.json();console.error("Error fetching admin chats:",a),s([])}}catch(e){console.error("Error loading admin chats:",e),s([])}f(!1)},_=e.filter(e=>{var s,a,t,r;let l=(null===(s=e.pet)||void 0===s?void 0:s.name.toLowerCase().includes(p.toLowerCase()))||(null===(a=e.pet)||void 0===a?void 0:a.breed.toLowerCase().includes(p.toLowerCase()))||(null===(t=e.user_email)||void 0===t?void 0:t.toLowerCase().includes(p.toLowerCase()))||(null===(r=e.owner_email)||void 0===r?void 0:r.toLowerCase().includes(p.toLowerCase())),i="all"===y||e.status===y;return l&&i}),Z=async e=>{if(!(null==w?void 0:w.id)){alert("Пользователь не авторизован");return}try{console.log("Архивируем чат:",{chatId:e,userId:w.id});let s=await fetch("/api/chats/archive",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:e,userId:w.id,isOwner:!0})});if(console.log("Ответ сервера:",s.status,s.statusText),s.ok){let e=await s.json();console.log("Результат архивирования:",e),await C(),alert("Чат архивирован")}else{let e=await s.text();console.error("Ошибка ответа:",e);try{let s=JSON.parse(e);alert("Ошибка: ".concat(s.error))}catch(s){alert("Ошибка: ".concat(e))}}}catch(e){console.error("Ошибка архивирования чата:",e),alert("Ошибка при архивировании чата")}},z=async e=>{try{let s=await fetch("/api/chats/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:e,userId:null==w?void 0:w.id,isOwner:!0})});if(s.ok)await C(),alert("Чат восстановлен");else{let e=await s.json();alert("Ошибка: ".concat(e.error))}}catch(e){console.error("Ошибка восстановления чата:",e),alert("Ошибка при восстановлении чата")}},D=async e=>{if(confirm("Вы уверены, что хотите удалить этот чат? Это действие нельзя отменить."))try{let s=await fetch("/api/chats/delete",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:e,userId:null==w?void 0:w.id,isAdmin:!0})});if(s.ok)await C(),alert("Чат удален");else{let e=await s.json();alert("Ошибка: ".concat(e.error))}}catch(e){console.error("Ошибка удаления чата:",e),alert("Ошибка при удалении чата")}},E=e=>{let s=new Date(e),a=new Date().getTime()-s.getTime(),t=Math.floor(a/6e4),r=Math.floor(a/36e5),l=Math.floor(a/864e5);return t<1?"Только что":t<60?"".concat(t," мин. назад"):r<24?"".concat(r," ч. назад"):1===l?"Вчера":l<7?"".concat(l," дн. назад"):l<30?"".concat(Math.ceil(l/7)," нед. назад"):s.toLocaleDateString("ru-RU")};return w&&"agentgl007@gmail.com"!==w.email?(0,t.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,t.jsx)("div",{className:"container mx-auto px-4 py-8 max-w-4xl",children:(0,t.jsx)(i.Zb,{children:(0,t.jsxs)(i.aY,{className:"p-8 text-center",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Доступ запрещен"}),(0,t.jsx)("p",{className:"text-gray-600 mb-4",children:"Только администраторы могут управлять всеми чатами"}),(0,t.jsx)(v.default,{href:"/chats",children:(0,t.jsx)(l.z,{className:"bg-blue-500 hover:bg-blue-600",children:"Вернуться к моим чатам"})})]})})})}):(0,t.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,t.jsx)("header",{className:"bg-white shadow-sm border-b",children:(0,t.jsx)("div",{className:"container mx-auto px-4 py-4",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,t.jsx)(v.default,{href:"/admin",children:(0,t.jsxs)(l.z,{variant:"outline",size:"sm",children:[(0,t.jsx)(d.Z,{className:"h-4 w-4 mr-2"}),"Назад в админ-панель"]})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-xl font-semibold text-gray-900",children:"Управление чатами"}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Административная панель для управления всеми чатами"})]})]}),(0,t.jsx)("div",{className:"flex items-center space-x-2",children:(0,t.jsxs)(n.C,{variant:"outline",className:"text-purple-600 border-purple-300",children:[(0,t.jsx)(o.Z,{className:"h-3 w-3 mr-1"}),"Всего чатов: ",e.length]})})]})})}),(0,t.jsxs)("div",{className:"container mx-auto px-4 py-6 max-w-6xl",children:[(0,t.jsx)("div",{className:"mb-6 space-y-4",children:(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4",children:[(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(x.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),(0,t.jsx)(c.I,{placeholder:"Поиск по питомцам, пользователям...",value:p,onChange:e=>N(e.target.value),className:"pl-10"})]})}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(l.z,{variant:"all"===y?"default":"outline",size:"sm",onClick:()=>b("all"),children:["Все (",e.length,")"]}),(0,t.jsxs)(l.z,{variant:"active"===y?"default":"outline",size:"sm",onClick:()=>b("active"),children:["Активные (",e.filter(e=>"active"===e.status).length,")"]}),(0,t.jsxs)(l.z,{variant:"archived"===y?"default":"outline",size:"sm",onClick:()=>b("archived"),children:["Архивированные (",e.filter(e=>"archived"===e.status).length,")"]})]}),(0,t.jsxs)(l.z,{onClick:C,variant:"outline",size:"sm",children:[(0,t.jsx)(m.Z,{className:"h-4 w-4 mr-2"}),"Обновить"]})]})}),a?(0,t.jsxs)("div",{className:"flex items-center justify-center py-12",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"}),(0,t.jsx)("span",{className:"ml-2 text-gray-600",children:"Загружаем чаты..."})]}):0===_.length?(0,t.jsx)(i.Zb,{children:(0,t.jsxs)(i.aY,{className:"p-8 text-center",children:[(0,t.jsx)(h.Z,{className:"h-12 w-12 text-gray-300 mx-auto mb-4"}),(0,t.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:p?"Чаты не найдены":"Нет чатов"}),(0,t.jsx)("p",{className:"text-gray-600",children:p?"Попробуйте изменить поисковый запрос":"Чаты появятся здесь после создания"})]})}):(0,t.jsx)("div",{className:"space-y-4",children:_.map(e=>{var s,a,r,c,d;return(0,t.jsx)(i.Zb,{className:"archived"===e.status?"border-orange-200 bg-orange-50":"border-gray-200",children:(0,t.jsxs)(i.aY,{className:"p-4",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,t.jsx)("div",{className:"w-15 h-15 rounded-lg flex items-center justify-center ".concat("archived"===e.status?"bg-orange-200":"bg-gray-200"),children:"archived"===e.status?(0,t.jsx)(u.Z,{className:"h-6 w-6 text-orange-600"}):(0,t.jsx)(h.Z,{className:"h-6 w-6 text-gray-600"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("h3",{className:"font-semibold text-gray-900",children:[null===(s=e.pet)||void 0===s?void 0:s.name," • ",null===(a=e.pet)||void 0===a?void 0:a.breed]}),(0,t.jsxs)("p",{className:"text-sm text-gray-600",children:["ID чата: ",e.id.slice(0,8),"..."]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500 mt-1 space-y-1",children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("span",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),(0,t.jsx)("span",{className:"font-medium",children:"\uD83D\uDC64 Абонент (пишет):"})]}),(0,t.jsxs)("div",{className:"ml-4 text-xs",children:[(0,t.jsxs)("p",{children:["Email: ",e.user_email]}),(0,t.jsxs)("p",{children:["ID: ",e.user_id.slice(0,8),"..."]})]}),(0,t.jsxs)("div",{className:"flex items-center mt-2",children:[(0,t.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),(0,t.jsx)("span",{className:"font-medium",children:"\uD83C\uDFE0 Владелец (отвечает):"})]}),(0,t.jsxs)("div",{className:"ml-4 text-xs",children:[(0,t.jsxs)("p",{children:["Email: ",e.owner_email]}),(0,t.jsxs)("p",{children:["ID: ",e.owner_id.slice(0,8),"..."]})]})]})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(n.C,{variant:(null===(r=e.pet)||void 0===r?void 0:r.type)==="lost"?"destructive":"default",className:(null===(c=e.pet)||void 0===c?void 0:c.type)==="lost"?"bg-red-100 text-red-800":"bg-green-100 text-green-800",children:(null===(d=e.pet)||void 0===d?void 0:d.type)==="lost"?"Потерялся":"Найден"}),(0,t.jsx)(n.C,{variant:"outline",className:"archived"===e.status?"text-orange-600 border-orange-300":"text-green-600 border-green-300",children:"archived"===e.status?"Архивирован":"Активен"})]})]}),e.last_message&&(0,t.jsxs)("div",{className:"mb-2",children:[(0,t.jsx)("p",{className:"text-sm text-gray-600 truncate",children:e.last_message.text}),(0,t.jsxs)("p",{className:"text-xs text-gray-400",children:[E(e.last_message.created_at)," •","user"===e.last_message.sender_type?" Пользователь":" Владелец"]})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[(0,t.jsxs)("span",{children:["Создан: ",E(e.created_at)]}),e.archived_at&&(0,t.jsxs)("span",{children:["Архивирован: ",E(e.archived_at)]})]})]})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between mt-4 pt-3 border-t border-gray-200",children:[(0,t.jsx)(v.default,{href:"/chat/".concat(e.pet_id,"?chatId=").concat(e.id,"&from=admin"),children:(0,t.jsxs)(l.z,{variant:"outline",size:"sm",children:[(0,t.jsx)(h.Z,{className:"h-4 w-4 mr-1"}),"Открыть чат"]})}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:["active"===e.status?(0,t.jsxs)(l.z,{variant:"outline",size:"sm",onClick:()=>Z(e.id),className:"text-orange-600 border-orange-300 hover:bg-orange-50",children:[(0,t.jsx)(u.Z,{className:"h-4 w-4 mr-1"}),"Архивировать"]}):(0,t.jsxs)(l.z,{variant:"outline",size:"sm",onClick:()=>z(e.id),className:"text-green-600 border-green-300 hover:bg-green-50",children:[(0,t.jsx)(m.Z,{className:"h-4 w-4 mr-1"}),"Восстановить"]}),(0,t.jsxs)(l.z,{variant:"outline",size:"sm",onClick:()=>D(e.id),className:"text-red-600 border-red-300 hover:bg-red-50",children:[(0,t.jsx)(j.Z,{className:"h-4 w-4 mr-1"}),"Удалить"]})]})]})]})},e.id)})})]})]})}},2718:function(e,s,a){"use strict";a.d(s,{Z:function(){return t}});let t=(0,a(9205).Z)("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]])},8930:function(e,s,a){"use strict";a.d(s,{Z:function(){return t}});let t=(0,a(9205).Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])},5805:function(e,s,a){"use strict";a.d(s,{Z:function(){return t}});let t=(0,a(9205).Z)("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]])}},function(e){e.O(0,[580,432,972,105,971,117,744],function(){return e(e.s=3910)}),_N_E=e.O()}]);