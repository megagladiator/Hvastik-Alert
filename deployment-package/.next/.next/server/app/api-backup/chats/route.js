(()=>{var e={};e.id=1153,e.ids=[1153],e.modules={20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},71568:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},21986:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>f,patchFetch:()=>x,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{GET:()=>p,POST:()=>d});var a=t(73278),o=t(45002),i=t(54877),n=t(71309),u=t(30460);async function d(e){try{if(!u.p)return n.NextResponse.json({error:"Админский клиент Supabase не настроен"},{status:500});let{petId:r,userId:t,ownerId:s}=await e.json();if(!r||!t||!s)return n.NextResponse.json({error:"petId, userId и ownerId обязательны"},{status:400});let{data:a,error:o}=await u.p.from("chats").select("*").eq("pet_id",r).eq("user_id",t).eq("owner_id",s).eq("status","active").limit(1).single();if(o&&"PGRST116"!==o.code)return console.error("Ошибка проверки существующего чата:",o),n.NextResponse.json({error:o.message},{status:400});if(a)return n.NextResponse.json({data:a});let{data:i,error:d}=await u.p.from("chats").select("id").or(`user_id.eq.${t},owner_id.eq.${t}`).eq("status","active");if(d)return console.error("Ошибка проверки лимита чатов:",d),n.NextResponse.json({error:d.message},{status:400});if(i&&i.length>=10)return n.NextResponse.json({error:"Превышен лимит чатов. Максимум 10 активных чатов на пользователя."},{status:400});let{data:p,error:l}=await u.p.from("chats").insert({pet_id:r,user_id:t,owner_id:s,status:"active"}).select().single();if(l)return console.error("Ошибка создания чата:",l),n.NextResponse.json({error:l.message},{status:400});return n.NextResponse.json({data:p})}catch(e){return console.error("API error:",e),n.NextResponse.json({error:e.message},{status:500})}}async function p(e){try{if(!u.p)return n.NextResponse.json({error:"Админский клиент Supabase не настроен"},{status:500});let{searchParams:r}=new URL(e.url),t=r.get("userId"),s=r.get("ownerId"),a=r.get("chatId");if(r.get("petId"),a){let{data:e,error:r}=await u.p.from("chats").select(`
          *,
          pets!inner(
            id,
            name,
            breed,
            type,
            status
          )
        `).eq("id",a).single();if(r)return console.error("Ошибка поиска чата по ID:",r),n.NextResponse.json({error:r.message},{status:400});let{data:t}=await u.p.auth.admin.listUsers(),s=new Map;return t?.users.forEach(r=>{r.id===e.user_id&&s.set(r.id,r.email||"Неизвестно"),r.id===e.owner_id&&s.set(r.id,r.email||"Неизвестно")}),n.NextResponse.json({data:[{...e,pet:e.pets,user_email:s.get(e.user_id)||"Неизвестно",owner_email:s.get(e.owner_id)||"Неизвестно"}]})}if(!t&&!s)return n.NextResponse.json({error:"userId или ownerId обязательны"},{status:400});let o=u.p.from("chats").select(`
        *,
        pets!inner(
          id,
          name,
          breed,
          type,
          status
        )
      `).eq("status","active").order("updated_at",{ascending:!1});t&&s?o=o.or(`user_id.eq.${t},owner_id.eq.${s}`):t?o=o.or(`user_id.eq.${t},owner_id.eq.${t}`):s&&(o=o.or(`user_id.eq.${s},owner_id.eq.${s}`));let{data:i,error:d}=await o;if(d)return console.error("Ошибка загрузки чатов:",d),n.NextResponse.json({error:d.message},{status:400});let p=i?.filter(e=>e.pets&&"active"===e.pets.status)||[],l=new Set;p.forEach(e=>{l.add(e.user_id),l.add(e.owner_id)});let c=Array.from(l),{data:m}=await u.p.auth.admin.listUsers(),g=new Map;m?.users.forEach(e=>{c.includes(e.id)&&g.set(e.id,e.email||"Неизвестно")});let f=await Promise.all(p.map(async e=>{let{data:r}=await u.p.from("messages").select("text, created_at, sender_type").eq("chat_id",e.id).order("created_at",{ascending:!1}).limit(1).single();return{...e,pet:e.pets,last_message:r||null,user_email:g.get(e.user_id)||"Неизвестно",owner_email:g.get(e.owner_id)||"Неизвестно"}}));return n.NextResponse.json({data:f})}catch(e){return console.error("API error:",e),n.NextResponse.json({error:e.message},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api-backup/chats/route",pathname:"/api-backup/chats",filename:"route",bundlePath:"app/api-backup/chats/route"},resolvedPagePath:"D:\\DATA\\Hvastik-Alert\\app\\api-backup\\chats\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:g}=l,f="/api-backup/chats/route";function x(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},30460:(e,r,t)=>{"use strict";t.d(r,{O:()=>n,p:()=>i});var s=t(52418);let a="https://erjszhoaxapnkluezwpy.supabase.co",o=process.env.SUPABASE_SERVICE_ROLE_KEY,i=a&&o?(0,s.eI)(a,o,{auth:{autoRefreshToken:!1,persistSession:!1}}):null,n=i||{from:()=>({select:()=>({eq:()=>({order:()=>Promise.resolve({data:null,error:Error("Supabase not configured")}),single:()=>Promise.resolve({data:null,error:Error("Supabase not configured")})})}),insert:()=>({select:()=>Promise.resolve({data:null,error:Error("Supabase not configured")}),single:()=>Promise.resolve({data:null,error:Error("Supabase not configured")})}),update:()=>({eq:()=>({select:()=>Promise.resolve({data:null,error:Error("Supabase not configured")})})})}),auth:{admin:{listUsers:()=>Promise.resolve({data:{users:[]},error:Error("Supabase not configured")}),getUserByEmail:()=>Promise.resolve({data:{user:null},error:Error("Supabase not configured")})}}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[7787,4833,2418],()=>t(21986));module.exports=s})();