(()=>{var e={};e.id=1786,e.ids=[1786],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},71568:e=>{"use strict";e.exports=require("zlib")},85083:(e,s,t)=>{"use strict";t.r(s),t.d(s,{GlobalError:()=>i.a,__next_app__:()=>m,originalPathname:()=>x,pages:()=>o,routeModule:()=>u,tree:()=>c}),t(73149),t(13973),t(90996);var r=t(30170),a=t(45002),l=t(83876),i=t.n(l),n=t(66299),d={};for(let e in n)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>n[e]);t.d(s,d);let c=["",{children:["chat",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(t.bind(t,73149)),"D:\\DATA\\Hvastik-Alert\\app\\chat\\[id]\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(t.bind(t,13973)),"D:\\DATA\\Hvastik-Alert\\app\\layout.tsx"],loading:[()=>Promise.resolve().then(t.bind(t,68199)),"D:\\DATA\\Hvastik-Alert\\app\\loading.tsx"],"not-found":[()=>Promise.resolve().then(t.t.bind(t,90996,23)),"next/dist/client/components/not-found-error"]}],o=["D:\\DATA\\Hvastik-Alert\\app\\chat\\[id]\\page.tsx"],x="/chat/[id]/page",m={require:t,loadChunk:()=>Promise.resolve()},u=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/chat/[id]/page",pathname:"/chat/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:c}})},7925:(e,s,t)=>{Promise.resolve().then(t.bind(t,11842))},11842:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>g});var r=t(97247),a=t(28964),l=t(58053),i=t(70170),n=t(27757),d=t(88964),c=t(20290),o=t(77940),x=t(97792),m=t(9969);let u=(0,t(26323).Z)("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);var h=t(79906),p=t(34178),f=t(92448);function g(){let e=(0,p.useParams)(),s=(0,p.useSearchParams)(),[t,g]=(0,a.useState)(null),[j,b]=(0,a.useState)(null),[N,y]=(0,a.useState)(!0),[v,w]=(0,a.useState)(""),[_,D]=(0,a.useState)(null),k=(0,a.useRef)(null),C=s.get("chatId"),S=s.get("from"),{messages:A,chat:E,loading:q,sending:Z,error:I,sendMessage:P}=function({petId:e,currentUserId:s,existingChatId:t}){let[r,l]=(0,a.useState)([]),[i,n]=(0,a.useState)(null),[d,c]=(0,a.useState)(!0),[o,x]=(0,a.useState)(!1),[m,u]=(0,a.useState)(null),[h,p]=(0,a.useState)(null);(0,a.useCallback)(async()=>{if(f.O&&s)try{if(t){let e=await fetch(`/api/chats?userId=${s}&chatId=${t}`);if(e.ok){let{data:s}=await e.json(),r=s?.find(e=>e.id===t);if(r)return n(r),r}}let r=await fetch(`/api/chats?userId=${s}&petId=${e}`);if(r.ok){let{data:t}=await r.json(),a=t?.find(t=>t.pet_id===e&&(t.user_id===s||t.owner_id===s)&&"active"===t.status);if(a)return n(a),a}let{data:a,error:l}=await f.O.from("pets").select("user_id, status").eq("id",e).single();if(l||!a)throw Error("Питомец не найден");if("active"!==a.status)throw Error("Питомец больше не доступен для общения");if(a.user_id===s)throw Error("Вы не можете создать чат с самим собой");let{data:{user:i}}=await f.O.auth.getUser();if(i?.email==="agentgl007@gmail.com")throw Error("Администратор может только просматривать существующие чаты");let d=await fetch("/api/chats",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({petId:e,userId:s,ownerId:a.user_id})});if(!d.ok){let e=await d.json();throw Error(e.error||"Ошибка создания чата")}let{data:c}=await d.json();return n(c),c}catch(e){return console.error("Error getting/creating chat:",e),u(e instanceof Error?e.message:"Ошибка при создании чата"),null}},[e,s,t]),(0,a.useCallback)(async e=>{try{let s=await fetch(`/api/messages?chatId=${e}`);if(!s.ok){let e=await s.json();console.error("Error loading messages:",e),u("Ошибка при загрузке сообщений");return}let{data:t}=await s.json();l(t||[])}catch(e){console.error("Error loading messages:",e),u(e instanceof Error?e.message:"Ошибка при загрузке сообщений")}},[]),(0,a.useCallback)(e=>{f.O&&p(f.O.channel(`chat:${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`chat_id=eq.${e}`},e=>{let s=e.new;l(e=>e.some(e=>e.id===s.id)?e:[...e,s])}).subscribe())},[]);let g=(0,a.useCallback)(async e=>{if(i&&s){x(!0);try{let t=i.owner_id===s?"owner":"user";if(i.id.startsWith("demo-")){let r={id:`demo-${Date.now()}`,chat_id:i.id,sender_id:s,sender_type:t,text:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};l(e=>[...e,r])}else{let r=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:i.id,senderId:s,senderType:t,text:e})});if(!r.ok){let e=await r.json();console.error("Error sending message to database:",e),u("Ошибка при отправке сообщения");return}let{data:a}=await r.json();a&&l(e=>e.some(e=>e.id===a.id)?e:[...e,a])}}catch(e){console.error("Error sending message:",e),u("Ошибка при отправке сообщения")}finally{x(!1)}}},[i,s]);return{messages:r,chat:i,loading:d,sending:o,error:m,sendMessage:g}}({petId:e.id,currentUserId:j?.id,existingChatId:C}),O=async e=>{e.preventDefault(),v.trim()&&j&&(await P(v),w(""))},T=e=>new Date(e).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});return N?r.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-orange-50 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:"Загружаем чат..."})]})}):_?r.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-orange-50 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center max-w-md mx-auto p-6",children:[r.jsx(c.Z,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),r.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Питомец недоступен"}),r.jsx("p",{className:"text-gray-600 mb-4",children:_}),r.jsx(h.default,{href:"/search",children:r.jsx(l.z,{className:"bg-orange-500 hover:bg-orange-600",children:"Найти других питомцев"})})]})}):t?j?(0,r.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-orange-50 flex flex-col",children:[r.jsx("header",{className:"bg-white shadow-sm border-b",children:r.jsx("div",{className:"container mx-auto px-4 py-4",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[r.jsx(h.default,{href:"admin"===S?"/admin/chats":"/chats",children:(0,r.jsxs)(l.z,{variant:"ghost",size:"sm",children:[r.jsx(o.Z,{className:"h-4 w-4 mr-2"}),"admin"===S?"К админ-панели":"К чатам"]})}),r.jsx(h.default,{href:`/pet/${t.id}`,children:r.jsx(l.z,{variant:"outline",size:"sm",children:"К объявлению"})}),(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[r.jsx("img",{src:t.photo_url||"/placeholder.svg?height=40&width=40",alt:t.name,className:"w-10 h-10 rounded-full object-cover"}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h1",{className:"font-semibold text-gray-900",children:[t.name," • ",t.breed]}),r.jsx("p",{className:"text-sm text-gray-600",children:t.contact_name})]}),r.jsx(d.C,{variant:"lost"===t.type?"destructive":"default",className:"lost"===t.type?"bg-red-100 text-red-800":"bg-green-100 text-green-800",children:"lost"===t.type?"Потерялся":"Найден"})]})]}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 flex items-center",children:[r.jsx(x.Z,{className:"h-3 w-3 mr-1"}),"Номер телефона скрыт для безопасности"]})]})})}),(0,r.jsxs)("div",{className:"flex-1 container mx-auto px-4 py-6 max-w-4xl",children:[(0,r.jsxs)(n.Zb,{className:"h-full flex flex-col",children:[(0,r.jsxs)(n.Ol,{className:"border-b",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)(n.ll,{className:"flex items-center",children:[r.jsx(m.Z,{className:"h-5 w-5 mr-2 text-orange-500"}),"Чат с владельцем"]}),r.jsx("p",{className:"text-sm text-gray-600",children:"Обсудите детали и договоритесь о встрече"})]}),r.jsx(h.default,{href:"admin"===S?"/admin/chats":"/chats",children:(0,r.jsxs)(l.z,{variant:"outline",size:"sm",children:[r.jsx(o.Z,{className:"h-4 w-4 mr-2"}),"admin"===S?"К админ-панели":"К чатам"]})})]}),r.jsx("div",{className:"mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200",children:(0,r.jsxs)("div",{className:"space-y-3",children:[r.jsx("div",{className:"flex items-center justify-between",children:(0,r.jsxs)("div",{className:"flex items-center",children:[r.jsx("span",{className:"w-3 h-3 bg-green-500 rounded-full mr-3"}),(0,r.jsxs)("div",{children:[r.jsx("p",{className:"text-sm text-blue-800 font-medium",children:"\uD83C\uDFE0 Владелец питомца"}),(0,r.jsxs)("p",{className:"text-sm text-blue-700",children:[r.jsx("strong",{className:"text-yellow-600",children:"Email:"})," ",r.jsx("span",{className:"text-yellow-600 font-medium",children:E?.owner_email||t.contact_email||"Не указан"})]}),(0,r.jsxs)("p",{className:"text-sm text-blue-700",children:[r.jsx("strong",{children:"Имя:"})," ",t.contact_name]})]})]})}),r.jsx("div",{className:"flex items-center justify-between",children:(0,r.jsxs)("div",{className:"flex items-center",children:[r.jsx("span",{className:"w-3 h-3 bg-blue-500 rounded-full mr-3"}),(0,r.jsxs)("div",{children:[r.jsx("p",{className:"text-sm text-blue-800 font-medium",children:"\uD83D\uDC64 Абонент"}),(0,r.jsxs)("p",{className:"text-sm text-blue-700",children:[r.jsx("strong",{className:"text-yellow-600",children:"Email:"})," ",r.jsx("span",{className:"text-yellow-600 font-medium",children:E?.user_email||"Загружается..."})]}),(0,r.jsxs)("p",{className:"text-sm text-blue-700",children:[r.jsx("strong",{children:"Имя:"})," ",E?.user_id===j?.id?j?.user_metadata?.full_name||"Не указано":E?.user_email?.split("@")[0]||"Не указано"]})]})]})}),r.jsx("div",{className:"pt-2 border-t border-blue-200",children:(0,r.jsxs)("p",{className:"text-xs text-blue-600 text-center",children:["\uD83D\uDC3E ",r.jsx("strong",{children:"Питомец:"})," ",t.name," • ",t.breed]})})]})})]}),(0,r.jsxs)(n.aY,{className:"flex-1 flex flex-col p-0",children:[(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 max-h-96",children:[q?(0,r.jsxs)("div",{className:"flex items-center justify-center py-8",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"}),r.jsx("span",{className:"ml-2 text-gray-600",children:"Загружаем сообщения..."})]}):0===A.length?r.jsx("div",{className:"flex items-center justify-center py-8",children:(0,r.jsxs)("div",{className:"text-center text-gray-500",children:[r.jsx(m.Z,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),r.jsx("p",{children:"Начните разговор первым!"}),r.jsx("p",{className:"text-sm",children:"Напишите сообщение владельцу питомца"})]})}):A.map(e=>{let s=e.sender_id===j?.id,a="owner"===e.sender_type,l=s?"Вы":a?`${t.contact_name} (владелец)`:"Абонент";return r.jsx("div",{className:`flex ${s?"justify-end":"justify-start"}`,children:(0,r.jsxs)("div",{className:`max-w-xs lg:max-w-md ${s?"items-end":"items-start"} flex flex-col`,children:[!s&&(0,r.jsxs)("p",{className:"text-xs text-gray-500 mb-1 ml-1 flex items-center",children:[r.jsx("span",{className:"mr-1",children:a?"\uD83C\uDFE0":"\uD83D\uDC64"}),l]}),(0,r.jsxs)("div",{className:`px-4 py-2 rounded-lg ${s?"bg-orange-500 text-white":a?"bg-green-100 text-green-900 border border-green-200":"bg-blue-100 text-blue-900 border border-blue-200"}`,children:[r.jsx("p",{className:"text-sm",children:e.text}),r.jsx("p",{className:`text-xs mt-1 ${s?"text-orange-100":a?"text-green-600":"text-blue-600"}`,children:T(e.created_at)})]}),s&&(0,r.jsxs)("p",{className:"text-xs text-gray-500 mt-1 mr-1 flex items-center",children:[r.jsx("span",{className:"mr-1",children:"\uD83D\uDC64"}),"Вы"]})]})},e.id)}),r.jsx("div",{ref:k})]}),(0,r.jsxs)("div",{className:"border-t p-4",children:[I&&r.jsx("div",{className:"mb-3 p-3 bg-red-50 border border-red-200 rounded-lg",children:r.jsx("p",{className:"text-sm text-red-600",children:I})}),j?.email==="agentgl007@gmail.com"?r.jsx("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:(0,r.jsxs)("div",{className:"flex items-center",children:[r.jsx(x.Z,{className:"h-5 w-5 text-yellow-600 mr-2"}),(0,r.jsxs)("div",{children:[r.jsx("p",{className:"text-sm text-yellow-800 font-medium",children:"Режим администратора"}),r.jsx("p",{className:"text-xs text-yellow-700 mt-1",children:"Вы можете только просматривать переписку. Отправка сообщений отключена."})]})]})}):(0,r.jsxs)("form",{onSubmit:O,className:"flex gap-2",children:[r.jsx(i.I,{value:v,onChange:e=>w(e.target.value),placeholder:"Напишите сообщение...",className:"flex-1",disabled:Z}),r.jsx(l.z,{type:"submit",className:"bg-orange-500 hover:bg-orange-600",disabled:Z||!v.trim(),children:Z?r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):r.jsx(u,{className:"h-4 w-4"})})]})]})]})]}),r.jsx(n.Zb,{className:"mt-4 border-yellow-200 bg-yellow-50",children:(0,r.jsxs)(n.aY,{className:"p-4",children:[r.jsx("h3",{className:"font-semibold text-yellow-800 mb-2",children:"Правила безопасности"}),(0,r.jsxs)("ul",{className:"text-sm text-yellow-700 space-y-1",children:[r.jsx("li",{children:"• Встречайтесь в людных местах"}),r.jsx("li",{children:"• Не передавайте деньги заранее"}),r.jsx("li",{children:"• Проверьте документы на животное"}),r.jsx("li",{children:"• Возьмите с собой друга или родственника"})]})]})})]})]}):r.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-orange-50 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center max-w-md mx-auto p-6",children:[r.jsx(c.Z,{className:"h-12 w-12 text-orange-500 mx-auto mb-4"}),r.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Требуется авторизация"}),r.jsx("p",{className:"text-gray-600 mb-4",children:"Для отправки сообщений необходимо войти в систему"}),r.jsx(h.default,{href:"/auth",children:r.jsx(l.z,{className:"bg-orange-500 hover:bg-orange-600",children:"Войти в систему"})})]})}):r.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-orange-50 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:"Загружаем чат..."})]})})}},27757:(e,s,t)=>{"use strict";t.d(s,{Ol:()=>n,Zb:()=>i,aY:()=>c,ll:()=>d});var r=t(97247),a=t(28964),l=t(25008);let i=a.forwardRef(({className:e,...s},t)=>r.jsx("div",{ref:t,className:(0,l.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",e),...s}));i.displayName="Card";let n=a.forwardRef(({className:e,...s},t)=>r.jsx("div",{ref:t,className:(0,l.cn)("flex flex-col space-y-1.5 p-6",e),...s}));n.displayName="CardHeader";let d=a.forwardRef(({className:e,...s},t)=>r.jsx("div",{ref:t,className:(0,l.cn)("text-2xl font-semibold leading-none tracking-tight",e),...s}));d.displayName="CardTitle",a.forwardRef(({className:e,...s},t)=>r.jsx("div",{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",e),...s})).displayName="CardDescription";let c=a.forwardRef(({className:e,...s},t)=>r.jsx("div",{ref:t,className:(0,l.cn)("p-6 pt-0",e),...s}));c.displayName="CardContent",a.forwardRef(({className:e,...s},t)=>r.jsx("div",{ref:t,className:(0,l.cn)("flex items-center p-6 pt-0",e),...s})).displayName="CardFooter"},70170:(e,s,t)=>{"use strict";t.d(s,{I:()=>i});var r=t(97247),a=t(28964),l=t(25008);let i=a.forwardRef(({className:e,type:s,...t},a)=>r.jsx("input",{type:s,className:(0,l.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",e),ref:a,...t}));i.displayName="Input"},77940:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(26323).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},20290:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(26323).Z)("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},9969:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(26323).Z)("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]])},97792:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(26323).Z)("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]])},79906:(e,s,t)=>{"use strict";t.d(s,{default:()=>a.a});var r=t(34080),a=t.n(r)},73149:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>r});let r=(0,t(45347).createProxy)(String.raw`D:\DATA\Hvastik-Alert\app\chat\[id]\page.tsx#default`)}};var s=require("../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[7787,1918,1086],()=>t(85083));module.exports=r})();